name: Delete All Deployments

on:
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  nuke-deployments:
    runs-on: ubuntu-latest

    steps:
      - name: List deployment IDs
        id: list
        run: |
          ids=$(gh api /repos/${{ github.repository }}/deployments --paginate --jq '[.[].id]')
          echo "ids=$ids" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete deployments & statuses
        run: |
          ids='${{ steps.list.outputs.ids }}'

          for id in $(echo "$ids" | jq -r '.[]'); do
            echo "Deleting deployment $id"

            # Get status list (may be empty or missing)
            status_ids=$(gh api /repos/${{ github.repository }}/deployments/$id/statuses --jq '[.[].id]' || echo '[]')

            for sid in $(echo "$status_ids" | jq -r '.[]'); do
              if [ -z "$sid" ] || [ "$sid" = "null" ]; then
                echo "  Skipping invalid status entry"
                continue
              fi

              echo "  Deleting status $sid"
              gh api -X DELETE /repos/${{ github.repository }}/deployments/$id/statuses/$sid || \
                echo "    (Status $sid already deleted â€” skipping)"
            done

            echo "  Deleting deployment $id"
            gh api -X DELETE /repos/${{ github.repository }}/deployments/$id || \
              echo "    (Deployment $id already gone â€” skipping)"
          done

          echo "ðŸŽ‰ Cleanup complete"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
